{
  "report": "See AUDIT_REPORT.md for comprehensive audit report",
  "patches": [
    {
      "file": "src/config/logger.ts",
      "changeType": "added",
      "diff": "New production logger using pino with structured JSON logs, request ID support, and sensitive data redaction"
    },
    {
      "file": "src/config/env.ts",
      "changeType": "added",
      "diff": "Environment variable validation with Zod schema, fails fast on startup with clear error messages"
    },
    {
      "file": "src/middleware/requestId.middleware.ts",
      "changeType": "added",
      "diff": "Request ID middleware for log correlation across requests"
    },
    {
      "file": "src/server.ts",
      "changeType": "modified",
      "diff": "Added graceful shutdown, proper port binding (PORT || APP_PORT || 4000), replaced console.log with logger, exported server for testing"
    },
    {
      "file": "src/app.ts",
      "changeType": "modified",
      "diff": "Added /healthz endpoint with DB and Redis status, request ID middleware, improved CORS configuration"
    },
    {
      "file": "src/worker/ocr.worker.ts",
      "changeType": "modified",
      "diff": "Added graceful shutdown for worker, replaced console calls with logger"
    },
    {
      "file": "src/config/queue.ts",
      "changeType": "modified",
      "diff": "Replaced console.log with logger for Redis connection events"
    },
    {
      "file": "package.json",
      "changeType": "modified",
      "diff": "Added pino and pino-pretty dependencies, added worker:prod script"
    },
    {
      "file": "Dockerfile",
      "changeType": "modified",
      "diff": "Multi-stage build, non-root user, health checks, optimized for production"
    },
    {
      "file": "render.yaml",
      "changeType": "modified",
      "diff": "Added worker service configuration, complete environment variable documentation"
    },
    {
      "file": "env.example",
      "changeType": "modified",
      "diff": "Added LOG_LEVEL, LOG_PRETTY, REQUEST_ID_HEADER variables with comments"
    }
  ],
  "commands": [
    "npm install",
    "npm run build",
    "npm start",
    "npm run worker:prod",
    "curl http://localhost:4000/healthz",
    "npm run lint",
    "npx tsc --noEmit"
  ],
  "renderGuide": "# Render Deployment Guide\n\n## Quick Start\n\n1. Connect GitHub repository to Render\n2. Create Web Service:\n   - Build Command: `npm install && npm run build`\n   - Start Command: `npm start`\n   - Health Check Path: `/healthz`\n3. Create Worker Service:\n   - Build Command: `npm install && npm run build`\n   - Start Command: `npm run worker:prod`\n4. Set environment variables (see render.yaml)\n5. Deploy\n\n## Required Environment Variables\n\n- MONGODB_URI\n- MONGODB_DB_NAME\n- JWT_ACCESS_SECRET (min 32 chars)\n- JWT_REFRESH_SECRET (min 32 chars)\n- AWS_ACCESS_KEY_ID\n- AWS_SECRET_ACCESS_KEY\n- S3_BUCKET_NAME\n- APP_FRONTEND_URL_APP\n- APP_FRONTEND_URL_ADMIN\n- REDIS_HOST (use Render Redis service URL)\n\n## Common Issues\n\n- Port binding: Server automatically uses PORT env var from Render\n- Health checks: Use /healthz endpoint\n- Worker: Ensure Redis is accessible from worker service\n- CORS: Set frontend URLs for production\n\nSee src/config/render.ts for detailed troubleshooting guide.",
  "envExample": "# Application\nAPP_ENV=development\nAPP_PORT=4000\nAPP_FRONTEND_URL_APP=https://app.example.com\nAPP_FRONTEND_URL_ADMIN=https://admin.example.com\n\n# MongoDB (REQUIRED)\nMONGODB_URI=mongodb+srv://username:password@cluster.mongodb.net/\nMONGODB_DB_NAME=expense_tracker\n\n# JWT (REQUIRED - secrets must be at least 32 characters)\nJWT_ACCESS_SECRET=changeme_access_secret_key_min_32_chars\nJWT_REFRESH_SECRET=changeme_refresh_secret_key_min_32_chars\nJWT_ACCESS_EXPIRES_IN=15m\nJWT_REFRESH_EXPIRES_IN=30d\n\n# AWS S3 (REQUIRED)\nAWS_REGION=ap-south-1\nS3_BUCKET_NAME=expense-tracker-aially\nAWS_ACCESS_KEY_ID=your_aws_access_key\nAWS_SECRET_ACCESS_KEY=your_aws_secret_key\n\n# Together AI (Optional but required for OCR)\nTOGETHER_AI_API_KEY=your_together_ai_api_key\nTOGETHER_AI_USER_KEY=your_together_ai_user_key\nTOGETHER_AI_MODEL_VISION=Qwen/Qwen2.5-VL-72B-Instruct\n\n# Firebase (Optional)\nFIREBASE_PROJECT_ID=your_firebase_project_id\nFIREBASE_CLIENT_EMAIL=your_firebase_client_email\nFIREBASE_PRIVATE_KEY=\"-----BEGIN PRIVATE KEY-----\\nYour private key here\\n-----END PRIVATE KEY-----\\n\"\nFIREBASE_DATABASE_URL=https://your-project.firebaseio.com\n\n# Resend (Optional)\nRESEND_API_KEY=your_resend_api_key\nRESEND_FROM_EMAIL=no-reply@aially.in\n\n# Redis (Required for OCR worker)\nREDIS_HOST=localhost\nREDIS_PORT=6379\nREDIS_PASSWORD=\nREDIS_DB=0\n\n# OCR Worker\nDISABLE_OCR=false\nOCR_WORKER_CONCURRENCY=3\n\n# Logging\nLOG_LEVEL=info\nLOG_PRETTY=false\nREQUEST_ID_HEADER=X-Request-ID",
  "testPlan": "# Test Plan\n\n## 1. Build and Start Server\n```bash\nnpm install\nnpm run build\nnpm start\n```\nExpected: Server starts on port 4000, logs show structured JSON\n\n## 2. Health Check\n```bash\ncurl http://localhost:4000/healthz\n```\nExpected: Returns 200 with DB and Redis status\n\n## 3. Test Request ID\n```bash\ncurl -H \"X-Request-ID: test-123\" http://localhost:4000/healthz\n```\nExpected: Response includes X-Request-ID header, logs include requestId\n\n## 4. Test Presign Upload\n```bash\n# Login first, then:\ncurl -X POST http://localhost:4000/api/v1/expenses/{expenseId}/receipts/upload-intent \\\n  -H \"Authorization: Bearer {token}\" \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\"filename\":\"test.jpg\",\"mimeType\":\"image/jpeg\",\"sizeBytes\":1024}'\n```\nExpected: Returns presigned URL (not logged), receipt created\n\n## 5. Test Upload Confirm and Enqueue\n```bash\ncurl -X POST http://localhost:4000/api/v1/receipts/{receiptId}/confirm \\\n  -H \"Authorization: Bearer {token}\"\n```\nExpected: Receipt confirmed, OCR job enqueued\n\n## 6. Test Worker\n```bash\nnpm run worker:prod\n```\nExpected: Worker connects to Redis, processes OCR jobs\n\n## 7. Test OCR Job Polling\n```bash\ncurl http://localhost:4000/api/v1/ocr/jobs/{jobId} \\\n  -H \"Authorization: Bearer {token}\"\n```\nExpected: Returns job status (PENDING, PROCESSING, COMPLETED, FAILED)\n\n## 8. Test Graceful Shutdown\n```bash\n# Start server, then send SIGTERM:\nkill -SIGTERM {pid}\n```\nExpected: Server closes connections gracefully, exits cleanly\n\n## 9. Test Environment Validation\n```bash\n# Remove MONGODB_URI from .env\nnpm start\n```\nExpected: App fails fast with clear error message about missing MONGODB_URI"
}

